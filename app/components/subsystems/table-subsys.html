
<link rel="stylesheet" ng-href="{{ htmlPath }}/subsys_style.css">
<div ng-if="data" class="container" flex>
    <!--div class="table-controls table-editor-controls table-search"-->
    <div class="table table-search">
        <div layout-gt-sm="row" class="searchheader">
            <md-input-container layout="row" layout-align="start center" flex>
                <md-button ng-if="onSave" class="md-primary" ng-click="save($event)" ng-disabled="saveInProgress"
                    title="Overwrite the original data file">
                    {{saveInProgress ? saveInProgressText : 'Save'}}
                </md-button>
                <md-button class="md-secondary" ng-click="saveAs($event)" ng-disabled="saveAsInProgress"
                    title="Save to a new file">
                    {{saveAsInProgress ? saveInProgressText : 'Save as...'}}
                </md-button>
                <span ng-if="dataModified && !dataSaved" class="pull-right color-error">
                    Note: Data has been modified but not saved yet.
                </span>
            </md-input-container>
            <md-progress-circular ng-if="loading || listAllSubsysFamTrees"
                                md-mode="indeterminate"
                                class="table-loading"
                                md-diameter="40">
            </md-progress-circular>

            <md-input-container md-no-float layout-align="center center"
                search="opts.query" search-opts="opts" search-placeholder={{placeholder}}>
            </md-input-container>
            <md-input-container ng-if="noPagination" layout-align="center start">
                <label>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    Total {{data.length - 4}} {{resultText}}
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </label>
            </md-input-container>
            <md-input-container
                ng-if="!noPagination"
                pagination
                pagination-offset="opts.offset"
                pagination-limit="opts.limit"
                pagination-total="filtered.length"
                layout="row"
                layout-align="start center">
            </md-input-container>
        </div>
    </div>

    <table class="table table-striped table-bordered" ng-hide="filtered && filtered.length==0">
        <thead class='sticky'>
            <tr>
                <th sortable col-id="{{header[0].key}}"
                    ng-click="sortBy($event, header[0].key)">
                        {{::header[0].label}}
                </th>
                <th ng-repeat="h in header.slice(1) track by $index" col-id="{{h.key}}"
                    style="margin-bottom: 50px;"
                    ng-class="{active: selected.index == $index}"
                    context-menu="openMenu($event, $index, h)"
                    context-menu-close="closeMenu($event, h)"
                    data-target="dropdown-menu-target"
                    title="{{::h.label}}">
                        {{::h.label.substring(0, 20)}}...
                </th>
            </tr>
            <tr><th colspan="100" style="color: black; background-color: rgb(220, 228, 147);">
                <a ng-click="collapseHeaderRows()">
                    <span ng-show="!headerRowsCollapsed">(-)Collapse sub-Header Rows</span>
                    <span ng-show="headerRowsCollapsed">(+)Expand sub-Header Rows</span>
                </a>
            </th></tr>
            <tr ng-repeat="row in data.slice(0,3)" ng-show="!headerRowsCollapsed">
                <th ng-repeat="h in header" style="color: black; background-color: rgb(220, 228, 147);">
                    <span ng-if="h.hasOwnProperty('formatter')" bind-html-compile="h.formatter(row[h.key])"></span>
                    <a ng-if="h.hasOwnProperty('link')" ui-sref="{{h.link.state}}( h.link.getOpts(row) )"
                        ng-click="$event.stopPropagation();">
                        {{::row[h.key]}}
                    </a>

                    <span ng-if="!h.hasOwnProperty('formatter') && !h.hasOwnProperty('link')">
                        <a ng-if="h.hasOwnProperty('click')" ng-click="h.click(row)">{{::row[h.key]}}</a>
                        <span ng-if="!h.hasOwnProperty('click')">{{::row[h.key]}}</span>
                    </span>
                </th>
            </tr>
            <tr ng-repeat="row in data.slice(3,4)" ng-show="!headerRowsCollapsed">
                <th ng-repeat="h in header" style="color: black; background-color: rgb(220, 228, 147);"
                    ng-class="{active: selected.index == $index}"
                    context-menu="openComptMenu($event, $index, row, h)"
                    context-menu-close="closeComptMenu($event, h)"
                    data-target="dropdown-menu-target-compt"
                    title="Right click to select and add compartment(s)">
                    <span ng-if="h.hasOwnProperty('formatter')" bind-html-compile="h.formatter(row[h.key])"></span>

                    <span ng-if="!h.hasOwnProperty('formatter') && !h.hasOwnProperty('link')">
                        <a ng-if="h.hasOwnProperty('click')" ng-click="h.click(row)">{{::row[h.key]}}</a>
                        <span ng-if="!h.hasOwnProperty('click')">{{::row[h.key]}}</span>
                    </span>
                </th>
            </tr>
        </thead>
        <tbody>
        <tr ng-repeat="row in (filtered = ( data | filter: opts.query
                                                | filter: { Genome: '!' + 'Families' }
                                                | filter: { Genome: '!' + 'Reactions' }
                                                | filter: { Genome: '!' + 'Cofactors' }
                                                | filter: { Genome: '!' + 'Localizations' }
                        | orderBy : opts.sort.field : opts.sort.desc)
                        | limitTo : opts.limit : opts.offset)">
            <td>{{::row[header[0].key]}}</td>
            <td ng-repeat="h in header.slice(1)" style="border: 1px solid black;">
                <span ng-repeat="g in row[h.key]"
                    ng-class="{active: selected.index == $index}"
                    context-menu="openAnnoMenu($event, $index, g, row, h)"
                    context-menu-close="closeAnnoMenu($event, g, row, h)"
                    data-target="dropdown-menu-target-anno"
                    title="Right click to set annotation or to see details.">
                    <span ng-if="g['curation']" style="color: green;">
                        {{g['feature']}}<br>
                    </span>
                    <span ng-if="g['prediction']" style="color: blue;">
                        {{g['feature']}}<br>
                    </span>
                </span>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- right click dropdown context menu -->
    <div class="dropdown position-fixed" id="dropdown-menu-target-compt" style="z-index: 5">
        <ul class="dropdown-menu" role="menu">
            <li ng-repeat="c in compartments">
                <a role="menuitem" tabindex="1"
                   ng-click="comptSelected($event, c, selectedCompt)">
                   {{c}}
                </a>
            </li>
        </ul>
    </div>

    <!-- right click dropdown context menu -->
    <div class="dropdown position-fixed" id="dropdown-menu-target-anno" style="z-index: 5">
        <ul class="dropdown-menu" role="menu">
            <li ng-repeat="ga in geneannos">
                <a role="menuitem" tabindex="1"
                   ng-click="annoSelected($event, ga, selectedAnno)">
                   <span ng-if="ga.indexOf('curation') >= 0" style="color:green">{{ga}}</span>
                   <span ng-if="ga.indexOf('prediction') >= 0" style="color:blue">{{ga}}</span>
                   <span ng-if="ga.indexOf('details') >= 0" style="color: black">{{ga}}</span>
                </a>
            </li>
        </ul>
    </div>

    <div ng-if="!loading && !loadingFamTree && filtered.length == 0" class="item-not-found">
        No item found
    </div>
</div>